<!DOCTYPE html>
<html lang="en">
<head>
    <!-- প্রাথমিক অ্যাড স্ক্রিপ্ট - এটি অ্যাসিঙ্ক্রোনাসভাবে লোড হবে যাতে পেজ লোডিং ব্লক না হয় -->
    <script async>(function(d,z,s){s.src='https://'+d+'/401/'+z;try{(document.body||document.documentElement).appendChild(s)}catch(e){}})('groleegni.net',9704632,document.createElement('script'))</script>
    <meta charset="UTF-8">

    <!-- ================= SEO Tags Start ================= -->
    <title id="page-title">CineStream - Watch & Download Latest HD Movies</title>
    <meta name="description" id="meta-description" content="Watch your favorite new and classic movies and web series. Find a huge collection of films from various genres on our website. Stream online now.">
    <meta name="keywords" id="meta-keywords" content="movies, web series, watch online, stream movies, new movies, movie download, latest films, online cinema">
    <meta name="robots" content="index, follow">
    <link rel="canonical" id="canonical-url" href="https://hindimovie.netlify.app/">

    <!-- Open Graph / Facebook / LinkedIn / Pinterest -->
    <meta property="og:title" id="og-title" content="CineStream - Watch New Movies & Series">
    <meta property="og:description" id="og-description" content="Discover and stream a vast library of movies and web series online for free.">
    <meta property="og:image" id="og-image" content="https://i.ibb.co/CByYk59/cinestream-og-image.jpg">
    <meta property="og:url" id="og-url" content="https://hindimovie.netlify.app/">
    <meta property="og:type" id="og-type" content="website">
    <meta property="og:locale" content="en_US">

    <!-- Twitter Card -->
    <meta name="twitter:card" id="twitter-card" content="summary_large_image">
    <meta name="twitter:site" content="@yourtwitterhandle">
    <meta name="twitter:creator" content="@yourtwitterhandle">
    <meta name="twitter:title" id="twitter-title" content="CineStream - Watch New Movies & Series">
    <meta name="twitter:description" id="twitter-description" content="Discover and stream a vast library of movies and web series online for free.">
    <meta name="twitter:image" id="twitter-image" content="https://i.ibb.co/CByYk59/cinestream-og-image.jpg">

    <!-- Schema.org JSON-LD -->
    <script type="application/ld+json" id="website-schema">
    {
      "@context": "https://schema.org",
      "@type": "WebSite",
      "name": "CineStream",
      "url": "https://hindimovie.netlify.app/",
      "potentialAction": {
        "@type": "SearchAction",
        "target": {
          "@type": "EntryPoint",
          "urlTemplate": "https://hindimovie.netlify.app/?q={search_term_string}"
        },
        "query-input": "required name=search_term_string"
      }
    }
    </script>
    <script type="application/ld+json" id="movie-schema"></script>
    <!-- ================= SEO Tags End ================= -->

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <!-- Google Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>

    <style>
        :root {
            --primary-color: #FFA500;
            --background-color: #1a1a1a;
            --surface-color: #111111;
            --text-color: #e0e0e0;
            --font-family: 'Roboto', sans-serif;
            --button-bg-light: #333333;
            --button-border-color: #4a4a4a;
            --icon-color: #b0b0b0;
            /* New Dune Style Colors */
            --dune-bg: #0D1117;
            --dune-text: #E0E0E0;
            --dune-text-muted: #8B949E;
            --dune-button-bg: #3B82F6;
            --dune-separator: #21262d;
            --footer-bg-color: var(--background-color);
            --footer-text-color: #aaaaaa;
            --footer-link-color: #ffffff;
            --footer-social-color: var(--primary-color);
        }
        body {
            font-family: var(--font-family);
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            font-size: 16px;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        *, *::before, *::after {
            box-sizing: border-box;
        }

        /* --- Loader --- */
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--background-color); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; gap: 15px; }
        .spinner { border: 6px solid #f3f3f330; border-top: 6px solid var(--primary-color); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- Header --- */
        header { background-color: var(--background-color); padding: 12px 20px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.3); min-height: 60px; }
        .site-logo { display: flex; align-items: center; gap: 10px; font-size: 1.5rem; font-weight: 700; color: var(--text-color); margin: 0; user-select: none; white-space: nowrap; flex-shrink: 0; }
        .site-logo i { color: var(--primary-color); }
        .header-right-controls { display: flex; align-items: center; gap: 10px; }
        .search-container { display: flex; align-items: center; position: relative; background-color: var(--button-bg-light); border: 1px solid var(--button-border-color); border-radius: 8px; overflow: hidden; transition: all 0.3s ease; flex-shrink: 0; min-width: 36px; }
        .search-input { flex-grow: 0; width: 0; padding: 0; border: none; background: transparent; color: var(--text-color); font-size: 0.9rem; outline: none; transition: all 0.3s ease; opacity: 0; }
        .search-container.active .search-input { flex-grow: 1; width: auto; max-width: 100px; padding: 8px 10px; opacity: 1; }
        .search-toggle-btn, .menu-toggle-btn, .app-icon-btn { background-color: transparent; border: none; border-radius: 8px; width: 36px; height: 36px; display: flex; justify-content: center; align-items: center; cursor: pointer; transition: background-color 0.2s; flex-shrink: 0; padding: 0; }
        .search-toggle-btn:hover, .menu-toggle-btn:hover, .app-icon-btn:hover { background-color: rgba(255,255,255,0.08); }
        .search-toggle-btn i, .menu-toggle-btn i { color: var(--icon-color); font-size: 1rem; }
        .menu-toggle-btn, .app-icon-btn { background-color: var(--button-bg-light); border: 1px solid var(--button-border-color); }
        .app-icon-btn .app-icon-img { width: 100%; height: 100%; object-fit: contain; display: block; border-radius: 6px; }

        /* --- Main Content --- */
        main { padding: 20px; flex-grow: 1; }
        #category-filters { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 10px; }
        .filter-btn { padding: 8px 18px; border: 1px solid #555; background: none; color: var(--text-color); border-radius: 20px; cursor: pointer; white-space: nowrap; }
        .filter-btn.active, .filter-btn:hover { background-color: var(--primary-color); color: #111; border-color: var(--primary-color); }

        /* --- Movie Grid --- */
        #movie-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 15px; }
        .movie-card { background-color: var(--surface-color); border-radius: 8px; overflow: hidden; cursor: pointer; transition: transform 0.2s; display: flex; flex-direction: column; }
        .movie-card:hover { transform: scale(1.05); }
        .movie-poster-wrapper { position: relative; width: 100%; aspect-ratio: 2 / 3; }
        .movie-poster-wrapper img { width: 100%; height: 100%; object-fit: cover; }
        .movie-card h3 { font-size: 0.9rem; padding: 10px; margin: 0; text-align: center; color: var(--text-color); }
        .save-button { position: absolute; top: 8px; right: 8px; background-color: rgba(0,0,0,0.6); border-radius: 50%; width: 30px; height: 30px; display: flex; justify-content: center; align-items: center; z-index: 5; border: none; color: #fff; }
        .rating-display { position: absolute; bottom: 8px; left: 8px; background: rgba(0,0,0,0.6); color: #f5c518; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; z-index: 5; }
        
        /* --- Side Menu --- */
        #side-menu-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); z-index: 1050; display: none; justify-content: flex-end; opacity: 0; transition: opacity 0.3s ease; }
        #side-menu-overlay.active { display: flex; opacity: 1; }
        #side-menu { background-color: var(--surface-color); width: 250px; height: 100%; padding: 20px; transform: translateX(100%); transition: transform 0.3s ease; }
        #side-menu-overlay.active #side-menu { transform: translateX(0); }
        .menu-options { list-style: none; padding: 0; margin-top: 30px; }
        .menu-options li a { display: flex; align-items: center; gap: 10px; color: var(--text-color); text-decoration: none; font-size: 1.1rem; padding: 10px; }
        
        /* --- Movie Modal Style --- */
        #movie-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--dune-bg); z-index: 1001; display: none; overflow-y: auto; }
        .modal-container { width: 100%; max-width: 500px; margin: 0 auto; color: var(--dune-text); }
        .modal-content-container { padding: 1.5rem; display: flex; flex-direction: column; gap: 1.5rem; }
        .modal-section h3 { font-size: 1.5rem; font-weight: 700; margin-bottom: 1rem; }
        hr.modal-separator { border: 0; height: 1px; background-color: var(--dune-separator); }
        .latest-movies-grid { display: flex; overflow-x: auto; gap: 1rem; padding-bottom: 10px; scrollbar-width: none; }
        .latest-movies-grid::-webkit-scrollbar { display: none; }
        .latest-movie-item { flex-shrink: 0; width: 100px; cursor: pointer; }
        .latest-movie-item img { width: 100%; border-radius: 8px; margin-bottom: 0.5rem; }
        .latest-movie-item p { font-size: 0.75rem; text-align: center; }
        .description-text { display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; }
        .description-text.expanded { -webkit-line-clamp: unset; }
        .read-more-btn { color: var(--dune-button-bg); cursor: pointer; font-weight: 500; display: none; }

        /* -- Details View -- */
        #modal-details-view .poster-container { padding: 2.5rem 1.5rem 1.5rem; position: relative; }
        #modal-details-view .poster-container img { width: 100%; max-width: 280px; height: auto; aspect-ratio: 2 / 3; object-fit: cover; border-radius: 12px; margin: 0 auto; display: block; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        #modal-details-view h1 { text-align: center; font-size: 2.5rem; font-weight: 700; }
        #modal-details-view .meta-info { justify-content: center; display: flex; align-items: center; gap: 1rem; color: var(--dune-text-muted); font-size: 0.9rem; }
        #modal-details-view .watch-now-btn { background-color: var(--dune-button-bg); color: white; font-weight: bold; padding: 1rem; border-radius: 2rem; border: none; cursor: pointer; }
        
        /* -- Player View -- */
        #modal-player-view { display: none; }
        #modal-player-view .video-wrapper { position: relative; padding-bottom: 56.25%; height: 0; background: #000; }
        #modal-player-view .video-wrapper iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }
        #modal-player-view h1 { font-size: 2.2rem; font-weight: 700; }
        #modal-player-view .meta-info { display: flex; align-items: center; gap: 1.5rem; color: var(--dune-text-muted); font-size: 0.9rem; }
        
        /* -- Common -- */
        .modal-close-btn { position: absolute; top: 15px; right: 15px; width: 36px; height: 36px; background-color: rgba(0, 0, 0, 0.4); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.6rem; cursor: pointer; z-index: 20; }
        .cast-container { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem 1rem; }
        @media (max-width: 600px) { h1 { font-size: 2rem !important; } }
        
        /* --- Footer --- */
        footer { background-color: var(--footer-bg-color); color: var(--footer-text-color); padding: 20px 15px; text-align: center; margin-top: auto; box-shadow: 0 -2px 10px rgba(0,0,0,0.3); }
        .footer-logo { font-size: 2rem; font-weight: 700; color: var(--primary-color); margin-bottom: 5px; }
        .footer-nav ul { list-style: none; padding: 0; margin: 0 auto 20px auto; display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; }
        .footer-nav ul li a { color: var(--footer-link-color); text-decoration: none; font-size: 0.95rem; }
        .social-links { list-style: none; padding: 0; margin: 0 auto 20px auto; display: flex; justify-content: center; gap: 15px; }
        .social-links a { color: var(--footer-social-color); font-size: 1.4rem; }
        .footer-copyright { font-size: 0.8rem; color: var(--footer-text-color); }
        .footer-copyright span { color: var(--primary-color); font-weight: 500; }
    </style>
</head>
<body>
    <div id="loader"><div class="spinner"></div></div>

    <header>
        <div class="site-logo"><i class="fas fa-clapperboard"></i> CineStream</div>
        <div class="header-right-controls">
            <div class="search-container">
                <input type="search" id="search-input" class="search-input" placeholder="Search...">
                <button class="search-toggle-btn"><i class="fas fa-magnifying-glass"></i></button>
            </div>
            <button class="app-icon-btn" id="header-app-button" style="display: none;">
                <img src="https://ia800509.us.archive.org/0/items/68ab-4def-1a-22d-download-prev-ui/68ab4def1a22d_download_prev_ui.png" alt="Download APK" class="app-icon-img">
            </button>
            <button class="menu-toggle-btn" id="main-menu-toggle"><i class="fas fa-bars"></i></button>
        </div>
    </header>

    <main>
        <div id="category-filters"></div>
        <div id="movie-grid"></div>
    </main>
    
    <div id="side-menu-overlay">
        <div id="side-menu">
            <ul class="menu-options">
                <li><a href="#" id="menu-home-btn"><i class="fas fa-home"></i> Home</a></li>
                <li><a href="#" id="menu-saved-movies-btn"><i class="fas fa-bookmark"></i> Saved Movies</a></li>
            </ul>
        </div>
    </div>
    
    <!-- MOVIE MODAL START -->
    <div id="movie-modal">
        <!-- View 1: Details (Default) -->
        <div id="modal-details-view" class="modal-container">
            <div class="poster-container">
                 <span class="modal-close-btn" onclick="closeModal()">&times;</span>
                 <img id="details-poster-img" alt="Movie poster" src="">
            </div>
            <div class="modal-content-container">
                 <h1 id="details-title"></h1>
                 <div class="meta-info">
                     <span id="details-meta-year"></span>
                     <span>•</span>
                     <span>IMDB <span id="details-rating"></span></span>
                 </div>
                 <button id="main-watch-now-trigger-new" class="watch-now-btn">Watch Now</button>
                 <div>
                    <p id="details-description" class="description-text"></p>
                    <span id="details-read-more-btn" class="read-more-btn">Read More</span>
                 </div>
                 <hr class="modal-separator">
                 <div class="modal-section">
                    <h3>Cast & Crew</h3>
                    <p id="details-director" class="text-sm text-gray-400"></p>
                    <div id="details-cast-container" class="cast-container mt-4"></div>
                 </div>
                 <hr class="modal-separator">
                 <div class="modal-section">
                    <h3>Latest Movies</h3>
                    <div id="details-latest-movies" class="latest-movies-grid"></div>
                 </div>
            </div>
        </div>

        <!-- View 2: Player (Hidden by default) -->
        <div id="modal-player-view" class="modal-container">
             <div class="video-wrapper">
                <span class="modal-close-btn" onclick="closeModal()">&times;</span>
                <iframe id="modal-video-player" src="" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen></iframe>
             </div>
             <div class="modal-content-container">
                <h1 id="player-title"></h1>
                <div class="meta-info">
                    <span id="player-meta-year"></span>
                    <span><i class="far fa-clock"></i> 2h 15m</span>
                    <span>IMDB <span id="player-rating"></span></span>
                    <span><i class="far fa-heart"></i> Like</span>
                </div>
                <div>
                   <p id="player-description" class="description-text"></p>
                   <span id="player-read-more-btn" class="read-more-btn">Read More</span>
                </div>
                <hr class="modal-separator">
                <div class="modal-section">
                   <h3>Cast & Crew</h3>
                   <p id="player-director" class="text-sm text-gray-400"></p>
                   <div id="player-cast-container" class="cast-container mt-4"></div>
                </div>
                <hr class="modal-separator">
                <div class="modal-section">
                   <h3>Latest Movies</h3>
                   <div id="player-latest-movies" class="latest-movies-grid"></div>
                </div>
             </div>
        </div>
    </div>
    <!-- MOVIE MODAL END -->

    <footer>
        <h3 class="footer-logo">CineStream</h3>
        <nav class="footer-nav">
            <ul>
                <li><a href="#">Home</a></li>
                <li><a href="#">About</a></li>
                <li><a href="#">Movies</a></li>
                <li><a href="#">Privacy Policy</a></li>
            </ul>
        </nav>
        <ul class="social-links">
            <li><a href="#" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a></li>
            <li><a href="#" aria-label="Twitter"><i class="fab fa-twitter"></i></a></li>
            <li><a href="#" aria-label="Instagram"><i class="fab fa-instagram"></i></a></li>
        </ul>
        <p class="footer-copyright">© <span id="current-year"></span> <span>CineStream</span>. All Rights Reserved.</p>
    </footer>

    <script>
        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyD-tlrPK8s9h87PVqtvprBy_phcCqONLeU",
            authDomain: "my-movie-81a4b.firebaseapp.com",
            databaseURL: "https://my-movie-81a4b-default-rtdb.firebaseio.com",
            projectId: "my-movie-81a4b",
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const moviesRef = database.ref('movies');
        const siteSettingsRef = database.ref('siteSettings');

        // --- DOM Elements ---
        const loader = document.getElementById('loader');
        const movieGrid = document.getElementById('movie-grid');
        const modal = document.getElementById('movie-modal');
        const modalDetailsView = document.getElementById('modal-details-view');
        const modalPlayerView = document.getElementById('modal-player-view');
        const modalVideoPlayer = document.getElementById('modal-video-player');
        
        let allMovies = [];
        let savedMovieIds = new Set();
        let currentMovieData = null;

        // --- Main Functions ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('current-year').textContent = new Date().getFullYear();
            loadSavedMoviesFromLocalStorage();
            loadMoviesAndSettings();
            setupEventListeners();
        });
        
        function setupEventListeners() {
            // Side Menu
            const mainMenuToggle = document.getElementById('main-menu-toggle');
            const sideMenuOverlay = document.getElementById('side-menu-overlay');
            mainMenuToggle.addEventListener('click', () => sideMenuOverlay.classList.add('active'));
            sideMenuOverlay.addEventListener('click', (e) => { if (e.target === sideMenuOverlay) sideMenuOverlay.classList.remove('active'); });
            document.getElementById('menu-home-btn').addEventListener('click', (e) => { e.preventDefault(); sideMenuOverlay.classList.remove('active'); filterByCategory('All'); });
            document.getElementById('menu-saved-movies-btn').addEventListener('click', (e) => { e.preventDefault(); sideMenuOverlay.classList.remove('active'); filterByCategory('Saved'); });

            // Search Bar
            const searchContainer = document.querySelector('.search-container');
            const searchInput = document.getElementById('search-input');
            document.querySelector('.search-toggle-btn').addEventListener('click', () => {
                searchContainer.classList.toggle('active');
                if (searchContainer.classList.contains('active')) searchInput.focus();
            });
            searchInput.addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                const filtered = allMovies.filter(movie => movie.title.toLowerCase().includes(term));
                displayMovies(filtered);
            });
        }

        function loadMoviesAndSettings() {
            loader.style.display = 'flex';
            Promise.all([
                moviesRef.orderByChild('timestamp').once('value'),
                siteSettingsRef.once('value')
            ]).then(([moviesSnapshot, settingsSnapshot]) => {
                // Load Movies
                const moviesData = moviesSnapshot.val();
                if (moviesData) {
                    allMovies = Object.entries(moviesData).map(([key, value]) => ({
                        key, ...value,
                        slug: (value.title || '').toLowerCase().replace(/[^\w\s-]/g, '').replace(/[\s_-]+/g, '-'),
                        rating: value.rating || (Math.random() * 2 + 7).toFixed(1)
                    })).reverse();
                    displayMovies(allMovies.filter(m => m.category !== 'upcoming'));
                    populateCategories();
                    handleUrlPath();
                }
                
                // Load Settings (for app download button)
                const settingsData = settingsSnapshot.val();
                const appButton = document.getElementById('header-app-button');
                if (settingsData && settingsData.appDownloadFileLink) {
                    appButton.style.display = 'flex';
                    appButton.onclick = () => window.open(settingsData.appDownloadFileLink, '_blank');
                } else {
                    appButton.style.display = 'none';
                }

                loader.style.display = 'none';
            });
        }

        function displayMovies(movies) {
            movieGrid.innerHTML = '';
            movies.forEach(movie => {
                const isSaved = savedMovieIds.has(movie.key);
                const card = document.createElement('div');
                card.className = 'movie-card';
                card.innerHTML = `<div class="movie-poster-wrapper"><img src="${movie.image}" loading="lazy"><button class="save-button"><i class="${isSaved ? 'fas' : 'far'} fa-bookmark"></i></button><div class="rating-display"><i class="fas fa-star"></i> <span>${movie.rating}</span></div></div><h3>${movie.title}</h3>`;
                card.addEventListener('click', (e) => {
                    if (e.target.closest('.save-button')) { e.stopPropagation(); toggleSaveMovie(movie.key, e.target.closest('.save-button')); } 
                    else { openModal(movie); }
                });
                movieGrid.appendChild(card);
            });
        }

        function populateCategories() {
            const categories = ['All', ...new Set(allMovies.map(m => m.category)), 'Saved'];
            const categoryFilters = document.getElementById('category-filters');
            categoryFilters.innerHTML = '';
            categories.forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'filter-btn';
                btn.textContent = category;
                if (category === 'All') btn.classList.add('active');
                btn.onclick = () => filterByCategory(category);
                categoryFilters.appendChild(btn);
            });
        }

        function filterByCategory(category) {
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.toggle('active', btn.textContent === category));
            const moviesToDisplay = category === 'Saved'
                ? allMovies.filter(movie => savedMovieIds.has(movie.key))
                : (category === 'All' ? allMovies.filter(m => m.category !== 'upcoming') : allMovies.filter(m => m.category === category));
            displayMovies(moviesToDisplay);
        }

        // --- Modal & Player Functions ---
        function openModal(movie) {
            currentMovieData = movie;
            
            modalDetailsView.style.display = 'block';
            modalPlayerView.style.display = 'none';
            modalVideoPlayer.src = '';
            
            history.pushState({ movieId: movie.key }, movie.title, `/movie/${movie.slug}`);
            document.title = `${movie.title} - CineStream`;

            populateViewData('details', movie);
            populateViewData('player', movie);

            document.getElementById('main-watch-now-trigger-new').onclick = switchToPlayerView;
            
            modal.style.display = 'block';
            modal.scrollTop = 0;
            document.body.style.overflow = 'hidden';
        }
        
        function populateViewData(viewPrefix, movie) {
            const releaseYear = movie.releaseDate ? movie.releaseDate.substring(0, 4) : 'N/A';
            document.getElementById(`${viewPrefix}-title`).textContent = movie.title;
            document.getElementById(`${viewPrefix}-meta-year`).innerHTML = `<i class="fa-solid fa-masks-theater"></i> ${movie.category} (${releaseYear})`;
            document.getElementById(`${viewPrefix}-rating`).textContent = movie.rating || 'N/A';
            document.getElementById(`${viewPrefix}-director`).textContent = `Director: ${movie.director || 'N/A'}`;
            
            if (viewPrefix === 'details') {
                document.getElementById('details-poster-img').src = movie.image;
            }

            // Description and Read More logic
            const descP = document.getElementById(`${viewPrefix}-description`);
            const readMoreBtn = document.getElementById(`${viewPrefix}-read-more-btn`);
            descP.textContent = movie.description || 'No description available.';
            descP.classList.remove('expanded');
            readMoreBtn.style.display = 'none';
            setTimeout(() => {
                if (descP.scrollHeight > descP.clientHeight) {
                    readMoreBtn.style.display = 'inline';
                }
            }, 100);
            readMoreBtn.onclick = () => {
                descP.classList.add('expanded');
                readMoreBtn.style.display = 'none';
            };
            
            const castContainer = document.getElementById(`${viewPrefix}-cast-container`);
            castContainer.innerHTML = '';
            if(movie.cast) {
                movie.cast.split(',').forEach(actor => {
                    const p = document.createElement('p'); p.textContent = actor.trim(); castContainer.appendChild(p);
                });
            }

            const latestGrid = document.getElementById(viewPrefix === 'details' ? 'details-latest-movies' : 'player-latest-movies');
            latestGrid.innerHTML = '';
            allMovies.filter(m => m.key !== movie.key).slice(0, 6).forEach(latest => {
                const item = document.createElement('div');
                item.className = 'latest-movie-item';
                item.innerHTML = `<img src="${latest.image}" alt="${latest.title}"><p>${latest.title}</p>`;
                item.onclick = () => openModal(latest);
                latestGrid.appendChild(item);
            });
        }

        function switchToPlayerView() {
            modalDetailsView.style.display = 'none';
            modalPlayerView.style.display = 'block';
            modal.scrollTop = 0;
            if (currentMovieData && currentMovieData.link) {
                modalVideoPlayer.src = currentMovieData.link;
            }
        }

        function closeModal() {
            history.pushState(null, "CineStream", '/');
            document.title = "CineStream - Watch & Download Latest HD Movies";
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
            modalVideoPlayer.src = ''; // Stop video
        }
        
        window.onpopstate = (event) => {
            if (modal.style.display === 'block') closeModal();
        };

        // --- Utility Functions ---
        function loadSavedMoviesFromLocalStorage() {
            const saved = localStorage.getItem('cineStreamSavedMovies');
            if (saved) savedMovieIds = new Set(JSON.parse(saved));
        }
        function saveMoviesToLocalStorage() {
            localStorage.setItem('cineStreamSavedMovies', JSON.stringify([...savedMovieIds]));
        }
        function toggleSaveMovie(movieId, buttonElement) {
            if (savedMovieIds.has(movieId)) {
                savedMovieIds.delete(movieId);
                buttonElement.querySelector('i').classList.replace('fas', 'far');
            } else {
                savedMovieIds.add(movieId);
                buttonElement.querySelector('i').classList.replace('far', 'fas');
            }
            saveMoviesToLocalStorage();
            if (document.querySelector('.filter-btn.active')?.textContent === 'Saved') filterByCategory('Saved');
        }
        function handleUrlPath() {
            const path = window.location.pathname;
            if (path.startsWith('/movie/')) {
                const slug = path.split('/movie/')[1];
                if (slug) {
                    const movie = allMovies.find(m => m.slug === slug);
                    if (movie) openModal(movie);
                }
            }
        }
    </script>
</body>
</html>
